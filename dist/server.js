"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e=require("dns"),t=require("fs-extra"),s=require("http"),n=require("path"),r=require("argparse"),o=require("body-parser"),i=require("compression"),a=require("express"),l=require("helmet"),c=require("mongoose"),h=require("opn"),p=require("socket.io"),u=require("winston"),d=require("./events/events"),g=require("./models/models"),v=require("./routes/routes");class m{constructor(){this.config={},this.env=process.env.NODE_ENV||"dev",this.events={client:null,group:null,lender:null,user:null},this.logger=null,this.helmet=l,this.models={Account:null,Client:null,Group:null,Lender:null,Transaction:null,User:null},this.opn=h,this.routes={accounts:null,admin:null,auth:null,client:null,clients:null,groups:null,lenders:null,general:null,transactions:null,users:null},this.status={online:!1},this.port=parseInt(process.env.PORT)||parseInt(process.env.C9_PORT)||parseInt(process.env.OPENSHIFT_NODEJS_PORT)||8e3,this.ip=process.env.IP||process.env.OPENSHIFT_NODEJS_IP||"127.0.0.1"}checkOnlineStatus(){return new Promise(t=>{e.resolve("www.google.com",(e,s)=>{e?(this.status.online=!1,t(!1)):(this.status.online=!0,t(!0))})})}connectSockets(){return new Promise((e,t)=>{this.events.client=new d.ClientsEvents(this,"clients"),this.events.group=new d.GroupsEvents(this,"groups"),this.events.lender=new d.LendersEvents(this,"lenders"),this.events.user=new d.UsersEvents(this,"users"),e()})}connectToDatabase(e){return new Promise((t,s)=>{this.database.connect_interval=setInterval(()=>{this.database.conn=c.connect(e,{autoReconnect:!0}),this.database.conn.then(()=>{process.stdout.write("Database connected\n"),clearInterval(this.database.connect_interval),t()}).catch(e=>{process.stdout.write("Couldn't connect database.\n"),t()})},3e3)})}getDbPath(e){return this.database={conn:null,connect_interval:null,db:null,path:""},new Promise((t,s)=>{let n="mongodb://";process.env.OPENSHIFT_MONGODB_DB_USERNAME&&process.env.OPENSHIFT_MONGODB_DB_PASSWORD&&(this.database.path+=n+process.env.OPENSHIFT_MONGODB_DB_USERNAME+":"+process.env.OPENSHIFT_MONGODB_DB_PASSWORD+"@"),process.env.OPENSHIFT_MONGODB_DB_HOST?this.database.path+=process.env.OPENSHIFT_MONGODB_DB_HOST+":":this.database.path+="127.0.0.1:",process.env.OPENSHIFT_MONGODB_DB_PORT?this.database.path+=process.env.OPENSHIFT_MONGODB_DB_PORT:this.database.path+="27017",this.database.path+=`/${this.config.appname}`,"dev"==process.env.NODE_ENV?t(`${n}${this.database.path}`):t(1==e?`${n}${this.config.database.user}:${this.config.database.pass}@${this.config.database.path}/${this.config.appname}`:`${n}${this.database.path}`)})}getLaunchConfig(){return new Promise((e,s)=>{t.readJSON(n.resolve(__dirname,"config.json"),(t,n)=>{if(t)return s(t);this.config=n;var o=new(0,r.ArgumentParser)({version:"1.0.0",addHelp:!0,description:this.config.appname});o.addArgument(["-n","--appname"],{action:"store",type:"string",help:"Name of the server. It controls the database to connect to and other settings."}),o.addArgument(["-p","--port"],{action:"store",type:"string",help:"Port to launch server on"}),o.addArgument(["--database"],{action:"store",type:"string",help:"\n              Name of the server. It controls the MongoDB database to connect to.\n              If the line ends with a slash, then option [-n,--appname] must be provided."}),o.addArgument(["-u","--dbuser"],{action:"store",type:"string",help:"user of the provided database"}),o.addArgument(["-l","--log"],{action:"store",choices:["0","1","2","3"],type:"int",help:"Controls logging level"}),o.addArgument(["--dbpass"],{action:"store",type:"string",help:"Password for provided database user. Ignored if user isn't provided."});var i=o.parseArgs();Object.keys(i).forEach(e=>{e in this.config&&("database"===e&&i[e]&&i[e].endsWith("/")&&!i.appname&&s("Invalid database path. When ending your database path with a slash you must provide an app name with [-n, --appname] option.\nExiting\n"),i[e]&&(this.config[e]=i[e]))});this.config;e(this.config)})})}static launch(){return new Promise((e,t)=>{let s=new m;s.getLaunchConfig().then(e=>{s.setUpLogger().then(()=>s.checkOnlineStatus().then(t=>s.getDbPath(t).then(t=>s.connectToDatabase(t).then(()=>s.modelDatabase().then(()=>s.setUpServer().then(t=>t.connectSockets().then(()=>t.setUpRoutes().then(t=>{t.startServer(t.port).then(e=>{process.stderr.write(`\nServer started\n${e.message}`)}).catch(s=>{"EADDRINUSE"==s.code&&(e.port++,t.startServer(e.port))})}).catch(console.error)).catch(console.error)).catch(console.error)).catch(console.error)).catch(console.error)).catch(console.error)))}).catch(console.error),e(this)})}modelDatabase(){return Promise.resolve(()=>{this.models={Account:new g.Account(this).fetchModel()||g.AccountModel,Client:new g.Client(this).fetchModel()||g.ClientModel,Group:new g.Group(this).fetchModel()||g.GroupModel,Lender:new g.Lender(this).fetchModel()||g.LenderModel,Transaction:new g.Transaction(this).fetchModel()||g.TransactionModel,User:new g.User(this).fetchModel()||g.UserModel}})}setUpLogger(){var e={file:{level:"info",filename:n.resolve(__dirname,"logs","app.log"),handleExceptions:!0,json:!0,maxsize:5242880,maxFiles:5,colorize:!0},console:{level:"debug",handleExceptions:!0,json:!1,colorize:!0}};return Promise.resolve(()=>{this.logger=new u.Logger({level:"verbose",transports:[new u.transports.Console,new u.transports.File(e.file),new u.transports.File({filename:n.resolve(this.config.log.files.error),level:"error"}),new u.transports.File({filename:n.resolve(this.config.log.files.debug),level:"debug"}),new u.transports.File({filename:n.resolve(this.config.log.files.info),level:"info"}),new u.transports.File({filename:n.resolve(this.config.log.files.silly),level:"silly"}),new u.transports.File({filename:n.resolve(this.config.log.files.verbose),level:"verbose"}),new u.transports.File({filename:n.resolve(this.config.log.files.warn),level:"warn"}),new u.transports.File({filename:n.resolve(this.config.log.files.full)})],exitOnError:!1}),"production"!==process.env.NODE_ENV&&this.logger.add(new u.transports.Console({}))})}setUpRoutes(){return new Promise((e,t)=>{this.app.use(o.json()),this.app.use(o.urlencoded({extended:!0})),this.app.use(i({threshold:1024})),this.app.all("*",(e,t,s)=>{t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Methods","PUT, GET, POST, DELETE, OPTIONS"),t.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),s()}),this.app.use("/",(e,t,s)=>{process.stdout.write(`${e.method.toUpperCase()}  ${e.path}\n`),s()}),this.app.use("/administration",a.static(n.join(__dirname,"views","admin"),{maxAge:"30s"})),this.app.use("/admin",a.static(n.join(__dirname,"views","admin"),{maxAge:"30s"})),this.app.use("/client",a.static(n.join(__dirname,"views","client"),{maxAge:"30s"})),this.app.use("/",a.static(n.join(__dirname,"views","admin"),{maxAge:"30s"})),this.routes.accounts=new v.AccountsRoutes(this),this.routes.auth=new v.AuthRoutes(this),this.routes.clients=new v.ClientsRoutes(this),this.routes.groups=new v.GroupsRoutes(this),this.routes.lenders=new v.LendersRoutes(this),this.routes.transactions=new v.TransactionsRoutes(this),this.routes.users=new v.UsersRoutes(this),this.routes.admin=new v.AdminRoutes(this),this.routes.client=new v.ClientRoutes(this),this.routes.general=new v.GeneralRoutes(this),e(this)})}setUpServer(){return new Promise((e,t)=>{this.app=a(),this.server=s.createServer(this.app),this.socket=p.listen(this.server),e(this)})}startServer(e){return new Promise((t,s)=>{this.server.listen(e||this.port,()=>{let e=this.server.address();console.log(process.env.NODE_ENV);let s=!1;"dev"!=process.env.NODE_ENV||s||(process.stdout.write(`Opening browser at http://localhost:${e.port}/admin`),s=!0,h(`http://localhost:${e.port}/admin`).then(e=>{}).catch(e=>{process.stdout.write("Couldn't launch browser")}),process.stdout.write(`Opening browser at http://localhost:${e.port}`),s=!0,h(`http://localhost:${e.port}`).then(e=>{}).catch(e=>{process.stdout.write("Couldn't launch browser")})),t({message:`\n${this.config.appname} running on ${e.address}:${e.port}\n`,address:e})}).on("error",e=>{s(e)})})}}exports.Mlipia=m,m.launch();